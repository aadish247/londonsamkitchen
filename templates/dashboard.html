{% extends "base.html" %}

{% block title %}Dashboard - London's Kitchen{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-chart-line"></i> Financial Dashboard</h1>
    <p class="dashboard-subtitle">Real-time overview of London's Kitchen finances</p>
</div>

<div class="dashboard-grid">
    <!-- Key Metrics Cards -->
    <div class="metric-card metric-card-primary">
        <div class="metric-icon">
            <i class="fas fa-pound-sign"></i>
        </div>
        <div class="metric-content">
            <h3>Total Investment</h3>
            <div class="metric-value" id="total-investment">£{{ "%.2f"|format(total_investment) }}</div>
            <div class="metric-trend positive">
                <i class="fas fa-arrow-up"></i>
                <span>Capital Invested</span>
            </div>
        </div>
    </div>

    <div class="metric-card metric-card-warning">
        <div class="metric-icon">
            <i class="fas fa-receipt"></i>
        </div>
        <div class="metric-content">
            <h3>Total Expenses</h3>
            <div class="metric-value" id="total-expenses">£{{ "%.2f"|format(total_expenses) }}</div>
            <div class="metric-trend negative">
                <i class="fas fa-arrow-down"></i>
                <span>Costs Incurred</span>
            </div>
        </div>
    </div>

    <div class="metric-card metric-card-success">
        <div class="metric-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="metric-content">
            <h3>Total Sales</h3>
            <div class="metric-value" id="total-sales">£{{ "%.2f"|format(total_sales) }}</div>
            <div class="metric-trend positive">
                <i class="fas fa-arrow-up"></i>
                <span>Revenue Generated</span>
            </div>
        </div>
    </div>

    <div class="metric-card metric-card-info">
        <div class="metric-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div class="metric-content">
            <h3>Net Profit/Loss</h3>
            <div class="metric-value {% if net_profit_loss >= 0 %}positive{% else %}negative{% endif %}" id="net-profit-loss">
                £{{ "%.2f"|format(net_profit_loss) }}
            </div>
            <div class="metric-trend {% if net_profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-{% if net_profit_loss >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                <span>Current Position</span>
            </div>
        </div>
    </div>
</div>

<!-- Investment Breakdown -->
<div class="dashboard-section">
    <h2><i class="fas fa-pie-chart"></i> Investment Breakdown</h2>
    <div class="investment-grid">
        <div class="investment-card">
            <div class="investor-avatar adwait">A</div>
            <div class="investment-details">
                <h3>Adwait Investment</h3>
                <div class="amount">£{{ "%.2f"|format(adwait_investment) }}</div>
                <div class="percentage">{{ "%.1f"|format((adwait_investment / total_investment * 100) if total_investment > 0 else 0) }}%</div>
            </div>
        </div>
        <div class="investment-card">
            <div class="investor-avatar shree">S</div>
            <div class="investment-details">
                <h3>Shree Investment</h3>
                <div class="amount">£{{ "%.2f"|format(shree_investment) }}</div>
                <div class="percentage">{{ "%.1f"|format((shree_investment / total_investment * 100) if total_investment > 0 else 0) }}%</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="dashboard-section">
    <h2><i class="fas fa-chart-line"></i> Financial Overview</h2>
    <div class="charts-grid">
        <!-- Monthly Sales Analysis -->
        <div class="chart-container">
            <h3><i class="fas fa-calendar-alt"></i> Monthly Sales Analysis ({{ current_year }})</h3>
            
            <!-- Visual Chart -->
            <div class="chart-wrapper">
                <canvas id="monthlySalesChart"></canvas>
            </div>
            
            <!-- Detailed Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Sales (£)</th>
                            <th>Orders</th>
                            <th>Expenses (£)</th>
                            <th>Profit/Loss (£)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(monthly_sales|length) %}
                        <tr>
                            <td>{{ monthly_sales[i].month }}</td>
                            <td class="amount">{{ "%.2f"|format(monthly_sales[i].total) }}</td>
                            <td>{{ monthly_sales[i].count }}</td>
                            <td class="amount">{{ "%.2f"|format(monthly_expenses[i].total) }}</td>
                            <td class="amount {% if monthly_sales[i].total - monthly_expenses[i].total >= 0 %}positive{% else %}negative{% endif %}">
                                {{ "%.2f"|format(monthly_sales[i].total - monthly_expenses[i].total) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total</th>
                            <th class="amount">{{ "%.2f"|format(monthly_sales|sum(attribute='total')) }}</th>
                            <th>{{ monthly_sales|sum(attribute='count') }}</th>
                            <th class="amount">{{ "%.2f"|format(monthly_expenses|sum(attribute='total')) }}</th>
                            <th class="amount {% if monthly_sales|sum(attribute='total') - monthly_expenses|sum(attribute='total') >= 0 %}positive{% else %}negative{% endif %}">
                                {{ "%.2f"|format(monthly_sales|sum(attribute='total') - monthly_expenses|sum(attribute='total')) }}
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Financial Summary -->
<div class="dashboard-section">
    <h2><i class="fas fa-calculator"></i> Financial Summary</h2>
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="summary-content">
                <h3>Return on Investment</h3>
                <div class="summary-value">{{ "%.1f"|format((net_profit_loss / total_investment * 100) if total_investment > 0 else 0) }}%</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">
                <i class="fas fa-balance-scale"></i>
            </div>
            <div class="summary-content">
                <h3>Profit Margin</h3>
                <div class="summary-value">{{ "%.1f"|format((net_profit_loss / total_sales * 100) if total_sales > 0 else 0) }}%</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">
                <i class="fas fa-crosshairs"></i>
            </div>
            <div class="summary-content">
                <h3>Break-even Point</h3>
                <div class="summary-value">£{{ "%.2f"|format(total_investment) }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="dashboard-section">
    <h2><i class="fas fa-clock"></i> Recent Activity</h2>
    <div class="activity-feed">
        {% for expense in recent_expenses %}
        <div class="activity-item">
            <div class="activity-icon expense">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="activity-content">
                <div class="activity-title">{{ expense.description }}</div>
                <div class="activity-meta">£{{ "%.2f"|format(expense.amount) }} - {{ expense.date.strftime('%d %b %Y') }}</div>
            </div>
        </div>
        {% endfor %}
        {% for sale in recent_sales %}
        <div class="activity-item">
            <div class="activity-icon sale">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="activity-content">
                <div class="activity-title">{{ sale.description or 'Sale' }}</div>
                <div class="activity-meta">£{{ "%.2f"|format(sale.amount) }} - {{ sale.date.strftime('%d %b %Y') }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Quick Actions -->
<div class="dashboard-section">
    <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
    <div class="quick-actions">
        <a href="{{ url_for('expenses') }}" class="action-btn">
            <i class="fas fa-plus"></i>
            <span>Add Expense</span>
        </a>
        <a href="{{ url_for('sales') }}" class="action-btn">
            <i class="fas fa-plus"></i>
            <span>Add Sale</span>
        </a>
        <a href="{{ url_for('investments') }}" class="action-btn">
            <i class="fas fa-plus"></i>
            <span>Add Investment</span>
        </a>
    </div>
</div>



<style>
    .dashboard-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .dashboard-subtitle {
        color: #7f8c8d;
        font-size: 1.2em;
        margin-top: 10px;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .metric-card-primary .metric-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .metric-card-warning .metric-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .metric-card-success .metric-icon {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .metric-card-info .metric-icon {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .metric-content h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .metric-value.positive {
        color: #27ae60;
    }
    
    .metric-value.negative {
        color: #e74c3c;
    }
    
    .metric-trend {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .metric-trend.positive {
        color: #27ae60;
    }
    
    .metric-trend.negative {
        color: #e74c3c;
    }
    
    .dashboard-section {
        margin-bottom: 40px;
    }
    
    .dashboard-section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .investment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .investment-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .investor-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
        color: white;
    }
    
    .investor-avatar.adwait {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .investor-avatar.shree {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .investment-details h3 {
        margin: 0 0 5px 0;
        color: #2c3e50;
    }
    
    .amount {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .percentage {
        font-size: 14px;
        color: #7f8c8d;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        max-width: 600px;
        gap: 20px;
        margin: 20px auto;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chart-container h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        text-align: center;
    }
    
    .chart-container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chart-container h3 {
        margin-top: 0;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    
    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .summary-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }
    
    .summary-content h3 {
        margin: 0 0 5px 0;
        color: #2c3e50;
        font-size: 14px;
        font-weight: 600;
    }
    
    .summary-value {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .activity-feed {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
    }
    
    .activity-icon.expense {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .activity-icon.sale {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 3px;
    }
    
    .activity-meta {
        font-size: 0.9em;
        color: #7f8c8d;
    }
    
    .quick-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        transition: transform 0.3s ease;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        color: white;
    }
    
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .investment-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            flex-direction: column;
        }
        
        .action-btn {
            justify-content: center;
        }
    }
</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Monthly Sales Chart
        const ctx = document.getElementById('monthlySalesChart').getContext('2d');
        
        // Prepare data from Jinja template
        const months = [{% for item in monthly_sales %}"{{ item.month }}",{% endfor %}];
        const salesData = [{% for item in monthly_sales %}{{ item.total }},{% endfor %}];
        const expensesData = [{% for item in monthly_expenses %}{{ item.total }},{% endfor %}];
        const profitData = salesData.map((sale, index) => sale - expensesData[index]);
        
        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Sales',
                        data: salesData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expenses',
                        data: expensesData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Profit/Loss',
                        data: profitData,
                        type: 'line',
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '£' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': £' + context.raw.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}